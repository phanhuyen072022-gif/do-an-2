@page
@model razor_page.Pages.DonHangCuaToiModel
@{
    ViewData["Title"] = "Đơn hàng của tôi";
}

<div class="container mt-4">
    <h2>Lịch sử đặt hàng của bạn</h2>

    @if (Model.DanhSachDonHang == null || !Model.DanhSachDonHang.Any())
    {
        <div class="alert alert-info">
            Bạn chưa có đơn hàng nào. <a href="/SanPham">Mua sắm ngay</a>
        </div>
    }
    else
    {
        <table class="table table-bordered table-striped mt-3">
            <thead class="table-dark">
                <tr>
                    <th>Mã ĐH</th>
                    <th>Tên đơn hàng</th>
                    <th>Sản phẩm (Hoa)</th>
                    <th>Số lượng</th>
                    <th>Ngày đặt</th>
                    <th>Tổng tiền</th>
                    <th>Trạng thái thanh toán</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.DanhSachDonHang)
                {
                    // Tính toán số tiền đã thanh toán từ danh sách ThanhToans của đơn hàng
                    decimal tongDaThanhToan = item.ThanhToans != null ? item.ThanhToans.Sum(t => t.TienDaThanhToan) : 0;
                    decimal soTienConLai = item.GiaDonHang - tongDaThanhToan;

                    <tr>
                        <td>#@item.DonHangId</td>
                        <td>@item.TenDonHang</td>
                        <td>@(item.Hoa != null ? item.Hoa.TenHoa : "N/A")</td>
                        <td>@item.SoLuong</td>
                        <td>@(item.ThoiGianDat?.ToString("dd/MM/yyyy HH:mm"))</td>
                        <td class="text-danger fw-bold">@item.GiaDonHang.ToString("N0") VNĐ</td>
                        <td>
                            @if (soTienConLai <= 0)
                            {
                                <span class="badge bg-success">Đã thanh toán đủ</span>
                            }
                            else if (tongDaThanhToan > 0)
                            {
                                <span class="badge bg-warning text-dark">Thanh toán một phần (Nợ: @soTienConLai.ToString("N0") VNĐ)</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Chưa thanh toán</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>